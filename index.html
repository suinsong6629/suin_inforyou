<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë¯¸ë˜ì „ëµ ì‚¬ì—…ë‹¨</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Gaegu:wght@400;700&family=Nanum+Gothic+Round:wght@400;700&display=swap');

        :root { 
            --primary-color: #3b82f6; 
            --link-color: #64748b;
            --bg-color: #f0f4f8;
            --card-bg: #ffffff;
            --border-color: #e2e8f0;
            --event-bg: #eff6ff;
            --text-dark: #334155; /* ì§„í•œ ê¸€ììƒ‰ */
        }

        body { 
            font-family: 'Nanum Gothic Round', sans-serif; 
            background-color: var(--bg-color); 
            display: flex; justify-content: center; align-items: flex-start; 
            min-height: 100vh; margin: 0; padding: 40px 20px; color: var(--text-dark); 
        }

        .container { 
            width: 100%; max-width: 700px; background: var(--card-bg); 
            padding: 40px; border-radius: 24px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.03); 
        }

        h1 { 
            font-family: 'Gaegu', cursive; 
            color: var(--primary-color); text-align: center; 
            font-size: 42px; margin-bottom: 30px; letter-spacing: -1px; 
        }

        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 30px; }
        .input-group { padding: 20px; border: 2px solid #f1f5f9; border-radius: 18px; }
        .section-title { font-size: 16px; font-weight: 700; margin-bottom: 15px; color: #475569; }
        label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 13px; color: #94a3b8; }
        input { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 10px; box-sizing: border-box; margin-bottom: 10px; font-family: 'Nanum Gothic Round'; }
        
        .btn-group { display: flex; flex-direction: column; gap: 12px; margin-bottom: 30px; }
        .btn { width: 100%; padding: 16px; border: none; border-radius: 15px; font-size: 17px; font-weight: 700; cursor: pointer; transition: 0.3s; text-decoration: none; display: flex; align-items: center; justify-content: center; box-sizing: border-box; font-family: 'Nanum Gothic Round'; }
        .btn-primary { background-color: var(--primary-color); color: white; padding: 20px; font-size: 19px; }
        .btn-primary:hover { background-color: #2563eb; transform: scale(1.02); }
        .btn-secondary { background-color: #f8fafc; color: var(--link-color); border: 1px solid #e2e8f0; }

        /* ìº˜ë¦°ë” ê°œì„  ë””ìì¸ */
        .calendar-section { margin-top: 40px; border-top: 3px dashed #e2e8f0; padding-top: 30px; }
        .calendar-header h2 { font-family: 'Gaegu', cursive; font-size: 28px; color: #475569; text-align: center; margin-bottom: 20px; }
        .calendar-table { width: 100%; border-collapse: separate; border-spacing: 4px; table-layout: fixed; }
        .calendar-table th { color: #64748b; font-size: 13px; padding: 10px; font-weight: bold; }
        
        .calendar-table td { 
            height: 100px; /* ë†’ì´ ì•½ê°„ ì¦ê°€ */
            vertical-align: top; padding: 8px; 
            background: #fff; border: 1px solid #f1f5f9; 
            border-radius: 12px; font-size: 12px; 
        }
        
        /* ë‚ ì§œ ìˆ«ì ìƒ‰ìƒ ì§„í•˜ê²Œ ìˆ˜ì • */
        .day-num { 
            font-weight: 800; margin-bottom: 6px; display: block; 
            color: #475569; /* íë¦° íšŒìƒ‰ì—ì„œ ì§„í•œ íšŒìƒ‰ìœ¼ë¡œ ë³€ê²½ */
        }
        .today .day-num { color: var(--primary-color); }
        .today { background-color: #eff6ff !important; border: 2px solid #bfdbfe !important; }

        /* ì´ë²¤íŠ¸ í…ìŠ¤íŠ¸ ì˜ë¦¼ ë°©ì§€ ë° ìŠ¤íƒ€ì¼ ìˆ˜ì • */
        .event-item { 
            font-size: 10.5px; color: #1e40af; line-height: 1.3; 
            margin-top: 4px; font-weight: 700; 
            background: var(--event-bg); padding: 3px 6px; 
            border-radius: 6px; 
            
            /* ì˜ë¦¼ ë°©ì§€ ì„¤ì • */
            white-space: normal;      /* ì¤„ë°”ê¿ˆ í—ˆìš© */
            word-break: keep-all;     /* ë‹¨ì–´ ë‹¨ìœ„ë¡œ ëŠê¸° */
            display: block;           /* ë°•ìŠ¤ í˜•íƒœë¡œ í‘œì‹œ */
            border-left: 3px solid var(--primary-color);
        }
        
        #status { text-align: center; margin-top: 15px; font-weight: 600; font-size: 14px; min-height: 20px; }
        #workingCanvas { display: none; }
        .footer { text-align: center; margin-top: 30px; font-size: 16px; color: #94a3b8; font-family: 'Gaegu'; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
</head>
<body>

<div class="container">
    <h1>ğŸ¢ ë¯¸ë˜ì „ëµ ì‚¬ì—…ë‹¨</h1>
    
    <div class="grid">
        <div class="input-group">
            <div class="section-title">ğŸ“‚ ì–‘ì‹ íŒŒì¼ ìœ ì§€</div>
            <label>ê³ ì§€ì˜ë¬´ ì´í–‰í™•ì¸ì„œ</label>
            <input type="file" id="file1" accept=".pdf" onchange="keepFile(1)">
            <div id="file1-msg" class="file-status" style="display:none; color:#10b981; font-size:11px; font-weight:bold;">âœ“ ë¡œë“œì™„ë£Œ</div>
            
            <label>í•„ìˆ˜ ë™ì˜ì„œ</label>
            <input type="file" id="file2" accept=".pdf" onchange="keepFile(2)">
            <div id="file2-msg" class="file-status" style="display:none; color:#10b981; font-size:11px; font-weight:bold;">âœ“ ë¡œë“œì™„ë£Œ</div>
        </div>

        <div class="input-group">
            <div class="section-title">ğŸ‘¤ ê¸°ì¬ ì •ë³´</div>
            <label>ê³„ì•½ ì²´ê²°ì¼</label>
            <input type="date" id="cDate">
            <label>ê³„ì•½ì ì„±ëª…</label>
            <input type="text" id="uName" placeholder="ì„±í•¨ ì…ë ¥">
            <label>ë‹´ë‹¹ ì„¤ê³„ì‚¬</label>
            <input type="text" id="pName" placeholder="ì„¤ê³„ì‚¬ ì„±í•¨">
        </div>
    </div>

    <div class="btn-group">
        <button class="btn btn-primary" onclick="startProcess()">ğŸ“¤ ì„œë¥˜ ìƒì„± ë° ë“œë¼ì´ë¸Œ ì „ì†¡</button>
        <div id="status"></div>
        <a href="https://pcs.iaa.or.kr/comm/login.do" target="_blank" class="btn btn-secondary">ğŸ”— ë¹„êµí™•ì¸ì„œ ë°”ë¡œê°€ê¸°</a>
    </div>

    <div class="calendar-section">
        <div class="calendar-header">
            <h2 id="calendar-title"></h2>
        </div>
        <table class="calendar-table" id="calendar-body">
            <thead>
                <tr>
                    <th style="color:#f87171">ì¼</th><th>ì›”</th><th>í™”</th><th>ìˆ˜</th><th>ëª©</th><th>ê¸ˆ</th><th style="color:#60a5fa">í† </th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="footer">ì˜¤ëŠ˜ë„ í˜ë‚´ì„¸ìš”! Â© 2025 ë¯¸ë˜ì „ëµ ì‚¬ì—…ë‹¨</div>
</div>

<canvas id="workingCanvas"></canvas>

<script>
    const eventData = {
        '2025-12-10': ['ìœ¤ì„±ë‹˜ íœ´ê°€', 'ì¬ì› ìƒë³´ì‹œí—˜'],
        '2025-12-23': ['í•˜ê²½ íœ´ê°€'],
        '2025-12-25': ['í¬ë¦¬ìŠ¤ë§ˆìŠ¤'],
        '2025-12-26': ['ì„¸í¬ íœ´ê°€', 'í™”ì¬ê²½ë³´ê¸° ì„¤ì¹˜'],
        '2025-12-31': ['ìˆ˜ì¸ íœ´ê°€'],
        '2026-01-01': ['ì‹ ì •'],
        '2026-01-02': ['ì „ì²´ë¯¸íŒ…'],
        '2026-01-16': ['ìˆ˜ì¸ íœ´ê°€'],
        '2026-01-23': ['ìˆ˜ì¸ íœ´ê°€']
    };

    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    const scriptURL = 'https://script.google.com/macros/s/AKfycbwi2Cc3n57UaOUPsZAijahVbM5GB0p0IRVL9VR8EzqyYpNMcT7tgiLVwI6Qcv5gZtWFBg/exec';

    let storedFile1 = null; let storedFile2 = null;

    function keepFile(num) {
        const fileInput = document.getElementById('file' + num);
        const msg = document.getElementById('file' + num + '-msg');
        if (fileInput.files[0]) {
            if (num === 1) storedFile1 = fileInput.files[0];
            else storedFile2 = fileInput.files[0];
            msg.style.display = 'block';
        }
    }

    function generateCalendar() {
        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth();
        
        document.getElementById('calendar-title').innerText = `${year}ë…„ ${month + 1}ì›”`;
        
        const firstDay = new Date(year, month, 1).getDay();
        const lastDate = new Date(year, month + 1, 0).getDate();
        const tbody = document.querySelector('#calendar-body tbody');
        tbody.innerHTML = '';

        let date = 1;
        for (let i = 0; i < 6; i++) {
            let row = document.createElement('tr');
            for (let j = 0; j < 7; j++) {
                let cell = document.createElement('td');
                if (i === 0 && j < firstDay) {
                } else if (date > lastDate) {
                } else {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(date).padStart(2, '0')}`;
                    cell.innerHTML = `<span class="day-num">${date}</span>`;
                    
                    if (date === now.getDate() && month === now.getMonth() && year === now.getFullYear()) {
                        cell.classList.add('today');
                    }

                    if (eventData[dateStr]) {
                        eventData[dateStr].forEach(task => {
                            cell.innerHTML += `<div class="event-item">ğŸ“ ${task}</div>`;
                        });
                    }
                    date++;
                }
                row.appendChild(cell);
            }
            tbody.appendChild(row);
            if (date > lastDate) break;
        }
    }

    window.onload = generateCalendar;

    async function startProcess() {
        const dateInput = document.getElementById('cDate').value;
        const name = document.getElementById('uName').value;
        const planner = document.getElementById('pName').value;

        if (!storedFile1 || !storedFile2 || !dateInput || !name || !planner) {
            alert("ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•´ ì£¼ì„¸ìš”."); return;
        }

        const status = document.getElementById('status');
        status.style.color = "#3b82f6";
        status.innerText = "âœ¨ ì „ì†¡ ì¤‘ì…ë‹ˆë‹¤...";

        try {
            const dateObj = new Date(dateInput);
            const d = { y: dateObj.getFullYear().toString().slice(-2), m: (dateObj.getMonth() + 1).toString(), day: dateObj.getDate().toString() };
            const img1Data = await getRenderedImageData(storedFile1, "ê³ ", d, name, planner);
            const img2Data = await getRenderedImageData(storedFile2, "ë™", d, name, planner);

            await fetch(scriptURL, {
                method: 'POST', mode: 'no-cors',
                body: JSON.stringify({
                    file1Data: img1Data, fileName1: `${name}_ê³ .jpg`,
                    file2Data: img2Data, fileName2: `${name}_ë™.jpg`
                })
            });

            status.style.color = "#10b981";
            status.innerText = "âœ… ì „ì†¡ ì™„ë£Œ! ë¹„êµí™•ì¸ì„œë¥¼ ì‘ì„±í•´ ì£¼ì„¸ìš”.";
        } catch (err) {
            status.style.color = "#ef4444";
            status.innerText = "âŒ ì „ì†¡ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.";
        }
    }

    async function getRenderedImageData(file, suffix, d, name, planner) {
        const canvas = document.getElementById('workingCanvas');
        await renderToCanvas(file, canvas, suffix, d, name, planner);
        return canvas.toDataURL('image/jpeg', 0.9);
    }

    async function renderToCanvas(file, canvas, suffix, d, name, planner) {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        const page = await pdf.getPage(1);
        const viewport = page.getViewport({ scale: 2.0 });
        const ctx = canvas.getContext('2d');
        canvas.width = viewport.width; canvas.height = viewport.height;
        ctx.fillStyle = "#ffffff"; ctx.fillRect(0, 0, canvas.width, canvas.height);
        await page.render({ canvasContext: ctx, viewport: viewport }).promise;
        const s = 2.0; const h = viewport.height;
        const draw = (t, x, y, sz=13) => { ctx.font=`${sz*s}px 'Malgun Gothic'`; ctx.fillStyle="black"; ctx.fillText(t,x*s,h-(y*s)); };
        const ck = (x, y) => { ctx.font=`bold ${22*s}px Arial`; ctx.fillStyle="red"; ctx.textAlign="center"; ctx.fillText("v",x*s,h-(y*s)); ctx.textAlign="start"; };

        if (suffix === "ê³ ") {
            [612, 579, 548, 504, 445, 385, 340, 310, 273].forEach(y => ck(500, y));
            draw(d.y, 199, 209); draw(d.m, 230, 209); draw(d.day, 256, 209);
            draw(name, 431, 209); draw(name, 500, 209);
            draw(d.y, 200, 96); draw(d.m, 225, 96); draw(d.day, 250, 96);
            draw(planner, 430, 96); draw(planner, 505, 96);
        } else {
            [640, 545, 428, 310, 234].forEach(y => ck(522, y));
            draw(d.y, 254, 138); draw(d.m, 300, 138); draw(d.day, 341, 138);
            draw(name, 150, 107); draw(name, 239, 107);
            draw("ë¯¸ë˜ì „ëµì‚¬ì—…ë‹¨", 150, 58, 11);
            draw(planner, 416, 64); draw(planner, 500, 64);
        }
    }
</script>
</body>
</html>
