<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë¯¸ë˜ì „ëµ ì‚¬ì—…ë‹¨</title>
    <style>
        :root { 
            --primary-color: #2563eb; 
            --link-color: #475569;
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --border-color: #e2e8f0;
        }
        body { font-family: 'Malgun Gothic', sans-serif; background-color: var(--bg-color); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; color: #1e293b; }
        .container { width: 100%; max-width: 700px; background: var(--card-bg); padding: 40px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        h1 { color: var(--primary-color); text-align: center; font-size: 32px; margin-bottom: 30px; letter-spacing: -1.5px; font-weight: 900; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 30px; }
        .input-group { padding: 20px; border: 1px solid var(--border-color); border-radius: 12px; }
        .section-title { font-size: 15px; font-weight: 700; margin-bottom: 15px; color: #334155; }
        label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 12px; color: #64748b; }
        input { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; box-sizing: border-box; margin-bottom: 10px; }
        .file-status { font-size: 11px; color: #10b981; font-weight: bold; margin-bottom: 10px; display: none; }
        .btn-group { display: flex; flex-direction: column; gap: 12px; }
        .btn { width: 100%; padding: 16px; border: none; border-radius: 10px; font-size: 17px; font-weight: 700; cursor: pointer; transition: 0.3s; text-decoration: none; display: flex; align-items: center; justify-content: center; box-sizing: border-box; }
        .btn-secondary { background-color: #f1f5f9; color: var(--link-color); border: 1px solid #cbd5e1; }
        .btn-primary { background-color: var(--primary-color); color: white; padding: 20px; font-size: 19px; box-shadow: 0 4px 10px rgba(37, 99, 235, 0.2); }
        .btn-primary:hover { background-color: #1d4ed8; transform: translateY(-1px); }
        #status { text-align: center; margin-top: 20px; font-weight: 600; font-size: 14px; min-height: 20px; }
        #workingCanvas { display: none; }
        .footer { text-align: center; margin-top: 30px; font-size: 12px; color: #94a3b8; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
</head>
<body>

<div class="container">
    <h1>ğŸ¢ ë¯¸ë˜ì „ëµ ì‚¬ì—…ë‹¨</h1>
    
    <div class="grid">
        <div class="input-group">
            <div class="section-title">ğŸ“‚ ì–‘ì‹ íŒŒì¼ ìœ ì§€</div>
            <label>ê³ ì§€ì˜ë¬´ ì´í–‰í™•ì¸ì„œ</label>
            <input type="file" id="file1" accept=".pdf" onchange="keepFile(1)">
            <div id="file1-msg" class="file-status">âœ“ ê³ ì§€ì–‘ì‹ ë¡œë“œì™„ë£Œ</div>
            
            <label>í•„ìˆ˜ ë™ì˜ì„œ</label>
            <input type="file" id="file2" accept=".pdf" onchange="keepFile(2)">
            <div id="file2-msg" class="file-status">âœ“ í•„ìˆ˜ì–‘ì‹ ë¡œë“œì™„ë£Œ</div>
        </div>

        <div class="input-group">
            <div class="section-title">ğŸ‘¤ ê¸°ì¬ ì •ë³´</div>
            <label>ê³„ì•½ ì²´ê²°ì¼</label>
            <input type="date" id="cDate">
            <label>ê³„ì•½ì ì„±ëª…</label>
            <input type="text" id="uName" placeholder="ì„±í•¨ ì…ë ¥">
            <label>ë‹´ë‹¹ ì„¤ê³„ì‚¬</label>
            <input type="text" id="pName" placeholder="ì„¤ê³„ì‚¬ ì„±í•¨">
        </div>
    </div>

    <div class="btn-group">
        <a href="https://pcs.iaa.or.kr/comm/login.do" target="_blank" class="btn btn-secondary">ğŸ”— ë¹„êµí™•ì¸ì„œ ë°”ë¡œê°€ê¸°</a>
        <button class="btn btn-primary" onclick="startProcess()">ğŸ“¤ ì„œë¥˜ ìƒì„± ë° ë“œë¼ì´ë¸Œ ì „ì†¡</button>
    </div>

    <div id="status"></div>
    <div class="footer">Â© 2025 ë¯¸ë˜ì „ëµ ì‚¬ì—…ë‹¨ All Rights Reserved.</div>
</div>

<canvas id="workingCanvas"></canvas>

<script>
    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    // ì‚¬ìš©ìê°€ ì œê³µí•œ êµ¬ê¸€ ì•±ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ URL
    const scriptURL = 'https://script.google.com/macros/s/AKfycbwi2Cc3n57UaOUPsZAijahVbM5GB0p0IRVL9VR8EzqyYpNMcT7tgiLVwI6Qcv5gZtWFBg/exec';

    let storedFile1 = null;
    let storedFile2 = null;

    function keepFile(num) {
        const fileInput = document.getElementById('file' + num);
        const msg = document.getElementById('file' + num + '-msg');
        if (fileInput.files[0]) {
            if (num === 1) storedFile1 = fileInput.files[0];
            else storedFile2 = fileInput.files[0];
            msg.style.display = 'block';
        }
    }

    async function startProcess() {
        const date = document.getElementById('cDate').value;
        const name = document.getElementById('uName').value;
        const planner = document.getElementById('pName').value;

        if (!storedFile1 || !storedFile2 || !date || !name || !planner) {
            alert("ì–‘ì‹ íŒŒì¼ê³¼ ëª¨ë“  ì •ë³´ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
            return;
        }

        const status = document.getElementById('status');
        status.style.color = "#f59e0b";
        status.innerText = "â³ ì„œë¥˜ë¥¼ ìƒì„±í•˜ì—¬ ë“œë¼ì´ë¸Œë¡œ ì „ì†¡ ì¤‘ì…ë‹ˆë‹¤...";

        try {
            const dateObj = new Date(date);
            const d = {
                y: dateObj.getFullYear().toString().slice(-2),
                m: (dateObj.getMonth() + 1).toString(),
                day: dateObj.getDate().toString()
            };

            // 1. ì´ë¯¸ì§€ ë°ì´í„° ìƒì„± (Base64 í˜•ì‹)
            const img1Data = await getRenderedImageData(storedFile1, "ê³ ", d, name, planner);
            const img2Data = await getRenderedImageData(storedFile2, "ë™", d, name, planner);

            // 2. êµ¬ê¸€ ì•±ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ë¡œ ì „ì†¡ (POST)
            // ë¸Œë¼ìš°ì € ë³´ì•ˆ ì •ì±…(CORS)ìœ¼ë¡œ ì¸í•´ 'no-cors' ëª¨ë“œë¥¼ ì‚¬ìš©í•˜ê±°ë‚˜ 
            // ì„œë²„ ì‘ë‹µ ì²˜ë¦¬ë¥¼ ìœ„í•´ ì¼ë°˜ fetchë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
            const response = await fetch(scriptURL, {
                method: 'POST',
                mode: 'no-cors', // êµ¬ê¸€ ìŠ¤í¬ë¦½íŠ¸ ì „ìš© ì„¤ì •
                cache: 'no-cache',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    file1Data: img1Data,
                    fileName1: `${name}_ê³ .jpg`,
                    file2Data: img2Data,
                    fileName2: `${name}_ë™.jpg`
                })
            });

            // no-cors ëª¨ë“œì—ì„œëŠ” ì‘ë‹µ ë‚´ìš©ì„ ì½ì„ ìˆ˜ ì—†ìœ¼ë¯€ë¡œ ì„±ê³µìœ¼ë¡œ ê°„ì£¼í•˜ê³  ë©”ì‹œì§€ ì¶œë ¥
            status.style.color = "#10b981";
            status.innerText = "âœ… ì „ì†¡ ì™„ë£Œ! 'ê³ ë™ë¹„' í´ë”ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.";
            
        } catch (err) {
            console.error(err);
            status.style.color = "#ef4444";
            status.innerText = "âŒ ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
        }
    }

    async function getRenderedImageData(file, suffix, d, name, planner) {
        const canvas = document.getElementById('workingCanvas');
        await renderToCanvas(file, canvas, suffix, d, name, planner);
        return canvas.toDataURL('image/jpeg', 0.9);
    }

    async function renderToCanvas(file, canvas, suffix, d, name, planner) {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        const page = await pdf.getPage(1);
        const viewport = page.getViewport({ scale: 2.0 });
        const ctx = canvas.getContext('2d');
        canvas.width = viewport.width;
        canvas.height = viewport.height;

        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        await page.render({ canvasContext: ctx, viewport: viewport }).promise;

        const s = 2.0; const h = viewport.height;
        const draw = (txt, x, pdfY, size = 13) => {
            ctx.font = `${size * s}px 'Malgun Gothic'`;
            ctx.fillStyle = "black";
            ctx.textAlign = "start";
            ctx.textBaseline = "alphabetic";
            ctx.fillText(txt, x * s, h - (pdfY * s));
        };
        const check = (x, pdfY) => {
            ctx.font = `bold ${22 * s}px Arial`;
            ctx.fillStyle = "red";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText("v", x * s, h - (pdfY * s));
        };

        if (suffix === "ê³ ") {
            [612, 579, 548, 504, 445, 385, 340, 310, 273].forEach(y => check(500, y));
            draw(d.y, 199, 209); draw(d.m, 230, 209); draw(d.day, 256, 209);
            draw(name, 431, 209); draw(name, 500, 209);
            draw(d.y, 200, 96); draw(d.m, 225, 96); draw(d.day, 250, 96);
            draw(planner, 430, 96); draw(planner, 505, 96);
        } else {
            [640, 545, 428, 310, 234].forEach(y => check(522, y));
            draw(d.y, 254, 138); draw(d.m, 300, 138); draw(d.day, 341, 138);
            draw(name, 150, 107); draw(name, 239, 107);
            draw("ë¯¸ë˜ì „ëµì‚¬ì—…ë‹¨", 150, 58, 11);
            draw(planner, 416, 64); draw(planner, 500, 64);
        }
    }
</script>

</body>
</html>
